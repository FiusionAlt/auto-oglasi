<!DOCTYPE html>
<html lang="hr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalji Oglasa</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 800px;
      margin: 40px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #2c3e50;
    }

    .car-image {
      width: 100%;
      height: 400px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }

    .info-item {
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .label {
      display: block;
      color: #6c757d;
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .value {
      font-size: 1.1em;
      color: #2c3e50;
    }

    .description {
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .back-button {
      display: inline-block;
      margin-top: 30px;
      padding: 12px 25px;
      background-color: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      transition: background-color 0.2s;
    }

    .back-button:hover {
      background-color: #0056b3;
    }

    .carousel-nav {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }

    .thumbnail {
      width: 80px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
    }

    .thumbnail.active {
      border-color: #007bff;
    }

    .carousel-button {
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .error {
      color: #e74c3c;
      text-align: center;
      padding: 20px;
    }

    .sync-status {
      text-align: center;
      margin-bottom: 20px;
      font-size: 0.9em;
      color: #6c757d;
    }

    .offline-warning {
      background-color: #fff3cd;
      color: #856404;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="container" id="detaljiContainer">
    <div id="syncStatus" class="sync-status"></div>
    <div id="offlineWarning" class="offline-warning" style="display: none;">
      Niste spojeni na internet. Prikazani su lokalno spremljeni podaci.
    </div>
    <h1>Detalji Oglasa</h1>
    <div id="sadrzaj"></div>
    <a class="back-button" href="index.html">⟵ Natrag</a>
  </div>

  <script>
    // GitHub Gist Configuration
    const GIST_ID = 'b9a62a1f2d5ccc2b20977c2e9016e2e7'; // Replace with your gist ID
    const GITHUB_TOKEN = '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'; // Replace with your GitHub token
    const GIST_FILENAME = 'auto-oglasi.json';

    // State
    let db;
    let currentCar = null;
    let currentImageIndex = 0;
    let isOnline = navigator.onLine;

    // Database Setup
    async function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onupgradeneeded = (event) => {
          db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
          }
        };

        request.onsuccess = (event) => {
          db = event.target.result;
          resolve();
        };

        request.onerror = (event) => reject(event.target.error);
      });
    }

    // Database Operations
    async function getCarFromDB(id) {
      return new Promise((resolve) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        tx.objectStore(STORE_NAME).get(id).onsuccess = (e) => resolve(e.target.result);
      });
    }

    // Updated getCarFromCloud with better error handling
    async function getCarFromCloud(id) {
      try {
        const response = await fetch(`https://api.github.com/gists/${GIST_ID}`);
        const data = await response.json();
        const cars = JSON.parse(data.files[GIST_FILENAME].content).cars || [];
        return cars.find(c => c.id == id) || null;
      } catch (error) {
        console.error('Gist load error:', error);
        return null;
      }
    }

    // Updated Hybrid Load Function
    // Updated loadCar function
    async function loadCar(id) {
      let car = null;

      if (isOnline) {
        try {
          car = await getCarFromCloud(id);
          if (car) {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).put(car);
            document.getElementById('syncStatus').textContent =
              `Podaci ažurirani s clouda (Bin ID: ${CURRENT_BIN_ID})`;
          }
        } catch (error) {
          console.error('Cloud load failed:', error);
        }
      }

      if (!car) {
        car = await getCarFromDB(id);
        document.getElementById('syncStatus').textContent = isOnline
          ? 'Nije uspjelo učitavanje s clouda, prikazani lokalni podaci'
          : 'Prikazani lokalno spremljeni podaci (offline)';
      }

      return car;
    }


    // Rendering
    function renderDetails() {
      if (!currentCar) return;

      const slike = currentCar.slike || [];
      document.getElementById('sadrzaj').innerHTML = `
        <div class="carousel">
          <img class="car-image" src="${slike[currentImageIndex] || 'img/placeholder.jpg'}" alt="${currentCar.naziv}">
          ${slike.length > 1 ? `
            <div class="carousel-nav">
              <button class="carousel-button" onclick="changeImage(-1)">‹ Prethodna</button>
              <button class="carousel-button" onclick="changeImage(1)">Sljedeća ›</button>
            </div>
            <div class="thumbnails">
              ${slike.map((img, i) => `
                <img class="thumbnail ${i === currentImageIndex ? 'active' : ''}" 
                     src="${img}" 
                     onclick="currentImageIndex = ${i}; renderDetails()">
              `).join('')}
            </div>
          ` : ''}
        </div>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Naziv:</span>
            <span class="value">${currentCar.naziv}</span>
          </div>
          <div class="info-item">
            <span class="label">Godina:</span>
            <span class="value">${currentCar.godina}</span>
          </div>
          <div class="info-item">
            <span class="label">Kilometraža:</span>
            <span class="value">${currentCar.kilometri}</span>
          </div>
          <div class="info-item">
            <span class="label">Cijena:</span>
            <span class="value">${currentCar.cijena}</span>
          </div>
          <div class="info-item">
            <span class="label">Kontakt:</span>
            <span class="value">${currentCar.vlasnik}</span>
          </div>
        </div>
        <div class="description">
          <h3>Opis</h3>
          <p>${currentCar.opis || 'Nema dostupnog opisa'}</p>
        </div>
      `;
    }

    window.changeImage = (dir) => {
      currentImageIndex = (currentImageIndex + dir + (currentCar.slike?.length || 0)) % (currentCar.slike?.length || 1);
      renderDetails();
    };

    // Network status detection
    function updateNetworkStatus() {
      document.getElementById('offlineWarning').style.display = isOnline ? 'none' : 'block';
    }

    window.addEventListener('online', () => {
      isOnline = true;
      updateNetworkStatus();
      // Try to reload fresh data when coming back online
      const urlParams = new URLSearchParams(window.location.search);
      const carId = parseInt(urlParams.get('id'));
      if (carId) loadCarAndRender(carId);
    });

    window.addEventListener('offline', () => {
      isOnline = false;
      updateNetworkStatus();
    });

    // Main initialization
    async function loadCarAndRender(id) {
      try {
        currentCar = await loadCar(id);
        if (!currentCar) throw new Error('Oglas nije pronađen');
        renderDetails();
      } catch (error) {
        document.getElementById('sadrzaj').innerHTML = `
          <div class="error">
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    (async () => {
      try {
        await initDB();
        updateNetworkStatus();

        const urlParams = new URLSearchParams(window.location.search);
        const carId = parseInt(urlParams.get('id'));

        if (!carId) throw new Error('Nevažeći ID');
        await loadCarAndRender(carId);
      } catch (error) {
        document.getElementById('sadrzaj').innerHTML = `
          <div class="error">
            <p>${error.message}</p>
          </div>
        `;
      }
    })();
  </script>
</body>

</html>